<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POS ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏≠‡∏ß‡∏≠‡∏á‡∏à‡∏¥‡∏ô‡∏ï‡∏Ñ‡∏ì‡∏¥‡∏ï</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <style>
    body {
      font-family: 'TH Sarabun New', sans-serif;
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    .card {
      border: 1px solid #ccc;
      padding: 1rem;
      margin-bottom: 1.5rem;
      border-radius: 8px;
      background-color: #f9f9f9;
    }
    label { display: block; margin: 0.5rem 0; }
    input[type="text"], select { width: 100%; padding: 0.5rem; margin-bottom: 1rem; }
    .total { font-weight: bold; font-size: 1.2rem; color: green; }
  </style>
</head>
<body>
  <h1>POS ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏±‡∏ö‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏≠‡∏ß‡∏≠‡∏á‡∏à‡∏¥‡∏ô‡∏ï‡∏Ñ‡∏ì‡∏¥‡∏ï</h1>
  <div class="card">
    <h2>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
    <input type="text" id="studentName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
    <input type="text" id="phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á">
    <label><input type="checkbox" id="isNewStudent"> ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤)</label>
  </div>
  <div class="card">
    <h2>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h2>
    <select id="courseSelect"></select>
    <label><input type="checkbox" id="includeBook"> üìó ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ô 180 ‡∏ö‡∏≤‡∏ó</label>
    <div id="summary"></div>
    <button onclick="addPayment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    <button onclick="exportPDF()">‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à PDF</button>
  </div>
  <div class="card" id="receiptContainer" style="display:none">
    <h2>üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h2>
    <div id="receiptText"></div>
    <div id="qr"></div>
  </div>
  <script>
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbzcpPpfhByzXC_JYiItzBWpZmYV_PbZxJtOU0_m7A7NMM8uffuVucxLCn7xeJ_evoGS/exec';
    const courseOptions = [
      { label: "1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", price: 1200, months: 1 },
      { label: "2 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î 200 ‡∏ö‡∏≤‡∏ó)", price: 2200, months: 2 },
      { label: "5 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ü‡∏£‡∏µ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)", price: 6000, months: 6 },
      { label: "9 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ü‡∏£‡∏µ 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)", price: 10800, months: 12 }
    ];
    const courseSelect = document.getElementById('courseSelect');
    courseOptions.forEach(c => {
      const opt = document.createElement('option');
      opt.value = JSON.stringify(c);
      opt.textContent = `${c.label} - ${c.price} ‡∏ö‡∏≤‡∏ó`;
      courseSelect.appendChild(opt);
    });

    function getSummary() {
      const bookFee = 180, memberFee = 200, bagFee = 150;
      const isNew = document.getElementById('isNewStudent').checked;
      const bookChecked = document.getElementById('includeBook').checked;
      const selected = JSON.parse(courseSelect.value);
      let tuition = selected.price;
      let discount = 0;
      let extra = 0;

      if (bookChecked) extra += bookFee;
      if (!isNew) {
        extra += memberFee + bagFee;
      }

      // ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£
      if (selected.months === 2) discount += 200;
      else if (selected.months === 12) discount += 3600;

      // ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏ü‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ (‡∏´‡∏±‡∏Å‡∏à‡∏≤‡∏Å extra ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
      if (isNew) {
        if (bookChecked) discount += bookFee;
        discount += memberFee + bagFee;
      }

      const total = tuition + extra - discount;
      return { tuition, discount, extra, total, label: selected.label, months: selected.months }; tuition, discount, extra, total, label: selected.label, months: selected.months };
    }

    function renderSummary() {
      const s = getSummary();
      document.getElementById('summary').innerHTML = `
        üìò ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: ${s.tuition.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
        üîñ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${s.discount.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
        üì¶ ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô: ${s.extra.toLocaleString()} ‡∏ö‡∏≤‡∏ó<br>
        <p class='total'>üí∞ ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${s.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
      `;
    }
    courseSelect.addEventListener('change', renderSummary);
    document.getElementById('isNewStudent').addEventListener('change', renderSummary);
    document.getElementById('includeBook').addEventListener('change', renderSummary);
    renderSummary();

    function addPayment() {
      const s = getSummary();
      const name = document.getElementById('studentName').value;
      const phone = document.getElementById('phone').value;
      const time = new Date().toLocaleString();
      document.getElementById('receiptText').innerHTML = `
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${name}</p>
        <p><strong>‡πÄ‡∏ö‡∏≠‡∏£‡πå:</strong> ${phone}</p>
        <p><strong>‡∏Ñ‡∏≠‡∏£‡πå‡∏™:</strong> ${s.label}</p>
        <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</strong> ${s.months}</p>
        <p><strong>‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</strong> ${s.tuition.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</strong> ${s.discount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô:</strong> ${s.extra.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong> ${s.total.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
        <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${time}</p>
      `;
      document.getElementById('receiptContainer').style.display = 'block';
      const qr = qrcode(0, 'L');
      qr.addData(`‡∏ä‡∏∑‡πà‡∏≠: ${name}
‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${s.total} ‡∏ö‡∏≤‡∏ó
‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${time}`);
      qr.make();
      document.getElementById('qr').innerHTML = qr.createImgTag(4);

      // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheets
      fetch(webAppUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name,
          phone,
          course: s.label,
          months: s.months,
          tuition: s.tuition,
          discount: s.discount,
          extra: s.extra,
          total: s.total,
          timestamp: time
        })
      })
      .then(res => res.text())
      .then(data => alert("üìå ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Sheet ‡πÅ‡∏•‡πâ‡∏ß"))
      .catch(err => alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet ‡πÑ‡∏î‡πâ"));
    }

    function exportPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.setFontSize(16);
      doc.text("‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏≠‡∏ß‡∏≠‡∏á‡∏à‡∏¥‡∏ô‡∏ï‡∏Ñ‡∏ì‡∏¥‡∏ï", 20, 20);
      doc.setFontSize(12);
      let y = 30;
      const txt = document.getElementById('receiptText').innerText.split('\n');
      txt.forEach(line => { doc.text(line, 20, y); y += 8; });
      doc.text("__________________________", 120, y + 10);
      doc.text("‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á", 145, y + 18);
      doc.text("* ‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á *", 20, y + 30);
      doc.save("receipt_levong.pdf");
    }
  </script>
</body>
</html>
